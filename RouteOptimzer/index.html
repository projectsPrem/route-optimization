<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Route Optimization & Real-Time Tracking</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" />
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: linear-gradient(120deg,#f5f7fa,#c3cfe2);
      color: #1a232d;
      margin: 0; padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      box-shadow: 0 4px 24px rgba(34,56,120,0.12);
      border-radius: 16px;
      padding: 30px 24px 24px 24px;
    }
    h2 {
      text-align: center;
      font-weight: 700;
      color: #243a73;
      margin-bottom: 24px;
    }
    label {
      font-weight: 700;
      color: #406882;
    }
    input[type=number] {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #dfe6f0;
      width: 130px;
      margin-right: 10px;
      margin-bottom: 10px;
      background: #f9fafb;
      font-size: 15px;
      transition: border 0.2s;
    }
    input[type=number]:focus {
      border: 1.5px solid #243a73;
      outline: none;
    }
    button {
      display: block;
      background: linear-gradient(90deg,#243a73,#4a6c94);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 28px;
      font-size: 17px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(60,70,100,0.1);
      margin: 20px auto 10px auto;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: linear-gradient(90deg,#406882,#243a73);
    }
    button:disabled {
      background: #a0aabb;
      cursor: default;
      box-shadow: none;
    }
    #map {
      height: 450px;
      width: 100%;
      border-radius: 12px;
      margin-top: 22px;
      box-shadow: 0 2px 8px rgba(60,70,100,0.07);
    }
    .form-section {
      background: #f3f8ff;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 24px;
      box-shadow: 0 1px 6px rgba(60,100,140,0.08);
    }
    .row-group {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 8px;
    }
    .order-fields {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    #orderStatusList {
      list-style:none;
      padding-left:0;
      margin-top: 12px;
      font-size: 15px;
    }
    #orderStatusList li {
      margin-bottom: 8px;
    }
    @media (max-width: 750px) {
      .container { padding: 12px 6px; }
      .row-group { flex-direction: column; gap: 8px; }
      input[type=number] { width: 100%; margin-right:0; }
      #map { height: 270px; }
    }
    pre {
      background: #eef3fb;
      border-radius: 7px;
      padding: 10px;
      font-size: 15px;
      margin-bottom: 0;
      box-shadow: 0 1px 6px rgba(60,70,120,0.05);
      overflow-x: auto;
      max-height: 250px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Route Optimization & Real-Time Tracking</h2>

    <div class="form-section">
      <span style="color:#243a73; font-weight:bold;">Vehicle Location</span>
      <div class="row-group">
        <label for="vehicleLon">Start Longitude</label>
        <input type="number" id="vehicleLon" value="8.681495" step="0.000001" required>
        <label for="vehicleLat">Start Latitude</label>
        <input type="number" id="vehicleLat" value="49.41461" step="0.000001" required>
      </div>
    </div>

    <form id="ordersForm" class="form-section">
      <span style="color:#243a73; font-weight:bold;">Order Locations (5)</span>
      <div id="ordersInputs"></div>
      <button type="button" onclick="submitOptimization()">Optimize & Track</button>
    </form>

    <div>
      <h3>Orders Status</h3>
      <ul id="orderStatusList"></ul>
    </div>

    <div id="map"></div>

    <h3 style="margin-bottom: 8px; color: #243a73;">API Response</h3>
    <pre id="response"></pre>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const map = L.map('map').setView([49.41461, 8.681495], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
    }).addTo(map);

    const orderStatusList = document.getElementById('orderStatusList');
    let vehicleMarker, routeLine;
    let animIndex = 0;
    let animCoordinates = [];
    let animTimer;

    const orderState = [];  // track if orders are delivered
    const orderMarkers = [];

    function createOrderInputs() {
      let html = '';
      orderStatusList.innerHTML = '';
      for(let i=1; i<=5; i++) {
        const defLon = 8.681495 + i*0.0015;
        const defLat = 49.41461 + i*0.0015;
        orderState[i-1] = false;

        html += `<div class="order-fields">
          <span style="font-weight:bold; width:70px;">Order ${i}</span>
          <label>Longitude</label>
          <input type="number" id="orderLon${i}" step="0.000001" required value="${defLon}">
          <label>Latitude</label>
          <input type="number" id="orderLat${i}" step="0.000001" required value="${defLat}">
        </div>`;

        orderStatusList.innerHTML += `<li id="orderStatus${i}">
          Order ${i} - <span style="color:red;">Pending</span>
          <button onclick="markDelivered(${i-1})" style="margin-left:15px; padding:4px 8px; cursor:pointer;">Mark Delivered</button>
        </li>`;
      }
      document.getElementById('ordersInputs').innerHTML = html;
    }

    createOrderInputs();

    function plotLocations(vehicleCoords, orders) {
      if(vehicleMarker) vehicleMarker.remove();
      orderMarkers.forEach(m => m.remove());
      orderMarkers.length = 0;

      if(routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
      }

      vehicleMarker = L.marker([vehicleCoords[1], vehicleCoords[0]], {
        icon: L.icon({
          iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-blue.png',
          shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12,41],
          popupAnchor: [1,-34],
          shadowSize: [41,41]
        })
      }).addTo(map).bindPopup('<b>Vehicle Start</b>').openPopup();

      orders.forEach((order, i) => {
        const iconUrl = orderState[i]
          ? 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-green.png'
          : 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-red.png';
        const m = L.marker([order[1], order[0]], {
          icon: L.icon({
            iconUrl,
            shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12,41],
            popupAnchor: [1,-34],
            shadowSize: [41,41]
          })
        }).addTo(map).bindPopup(`Order ${i+1} - ${orderState[i] ? 'Delivered' : 'Pending'}`);
        orderMarkers.push(m);
      });
    }

    function drawRoute(coords) {
      if(routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords.map(c => [c[1],c[0]]), {
        color: '#FE7A36',
        weight: 6,
        opacity: 0.85
      }).addTo(map);
      map.fitBounds(routeLine.getBounds());
    }

    function markDelivered(index) {
      if(orderState[index]) return; // ignore already delivered

      orderState[index] = true;
      const statusEl = document.getElementById(`orderStatus${index+1}`);
      statusEl.querySelector('span').textContent = 'Delivered';
      statusEl.querySelector('span').style.color = 'green';
      const btn = statusEl.querySelector('button');
      btn.disabled = true;
      btn.style.cursor = 'default';

      // Trigger route re-optimization after marking delivered
      submitOptimization();
    }

    function animateVehicle() {
      if(animTimer) clearTimeout(animTimer);
      if(animCoordinates.length === 0) return;

      animIndex = 0;
      vehicleMarker.setLatLng(animCoordinates[0]);
      map.panTo(animCoordinates[0]);

      function step() {
        animIndex++;
        if(animIndex >= animCoordinates.length) return;
        vehicleMarker.setLatLng(animCoordinates[animIndex]);
        map.panTo(animCoordinates[animIndex]);
        animTimer = setTimeout(step, 1000);
      }
      step();
    }

    function submitOptimization() {
      const vehicleCoords = [
        parseFloat(document.getElementById('vehicleLon').value),
        parseFloat(document.getElementById('vehicleLat').value)
      ];
      const orders = [];
      for(let i=1; i<=5; i++) {
        orders.push([
          parseFloat(document.getElementById('orderLon'+i).value),
          parseFloat(document.getElementById('orderLat'+i).value)
        ]);
      }
      plotLocations(vehicleCoords, orders);

      // Prepare vehicles and jobs with filter for undelivered jobs only
      const vehicles = [{
        id: 1,
        start: vehicleCoords,
        end: vehicleCoords,
        capacity: [5],
        profile: "driving-car"
      }];
      const jobs = orders.map((loc,i) => ({
        id: i+1,
        location: loc,
        service: 300
      })).filter((_, idx) => !orderState[idx]);

      if(jobs.length === 0) {
        document.getElementById('response').textContent = "All orders have been delivered.";
        if(routeLine) map.removeLayer(routeLine);
        if(vehicleMarker) vehicleMarker.remove();
        return;
      }

      const payload = {
        vehicles,
        jobs,
        geometry: true
      };

      document.getElementById('response').textContent = 'Sending optimization request...';

      fetch('http://127.0.0.1:8000/optimize-route', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      })
      .then(res=>res.json())
      .then(data => {
        document.getElementById('response').textContent = JSON.stringify(data, null, 2);
        if(data && data.routes && data.routes[0] && data.routes[0].geometry && data.routes[0].geometry.coordinates) {
          animCoordinates = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
          drawRoute(animCoordinates);
          animateVehicle();
        } else {
          if(routeLine) map.removeLayer(routeLine);
          animCoordinates = [];
        }
      })
      .catch(err => {
        document.getElementById('response').textContent = 'Error: ' + err;
      });
    }

  </script>
</body>
</html>
