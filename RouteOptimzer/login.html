<!DOCTYPE html>
<html>
<head>
<title>Login & Role-based Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #dashboard, #agentDashboard { display: none; margin-top: 20px; }
</style>
</head>
<body>

<h2>Login</h2>
<div>
  <input type="text" id="username" placeholder="Username" /><br><br>
  <input type="password" id="password" placeholder="Password" /><br><br>
  <button onclick="login()">Login</button>
</div>

<div id="message" style="color:red;margin-top:10px;"></div>

<div id="dashboard">
  <h3>Customer Dashboard</h3>
  <p>Welcome, <span id="custName"></span>!</p>
  <button onclick="fetchCustomerOrders()">View My Orders</button>
  <pre id="customerOrders"></pre>
  <button onclick="logout()">Logout</button>
</div>

<div id="agentDashboard">
  <h3>Delivery Agent Dashboard</h3>
  <p>Welcome, <span id="agentName"></span>!</p>
  <button onclick="fetchAgentAssignedOrders()">View Assigned Orders</button>
  <pre id="agentOrders"></pre>
  <button onclick="logout()">Logout</button>
</div>

<script>
const API_URL = 'https://your-elasticbeanstalk-url/api'; // Replace with your Flask API base

async function login() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  document.getElementById('message').textContent = '';

  if (!username || !password) {
    document.getElementById('message').textContent = 'Please enter username and password';
    return;
  }

  try {
    const res = await fetch(API_URL + '/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.message || 'Login failed');
    }

    const data = await res.json();
    const token = data.token;
    // Decode token to extract role (or store role separately if sent)
    const payload = JSON.parse(atob(token.split('.')[1]));
    const role = payload.role;
    const user = payload.user;

    localStorage.setItem('token', token);
    localStorage.setItem('role', role);
    localStorage.setItem('user', user);

    // Show dashboard based on role
    if (role === 'Customer') {
      showCustomerDashboard(user);
    } else if (role === 'DeliveryAgent') {
      showAgentDashboard(user);
    }

  } catch (error) {
    document.getElementById('message').textContent = error.message;
  }
}

function showCustomerDashboard(user) {
  document.getElementById('custName').textContent = user;
  document.getElementById('dashboard').style.display = 'block';
  document.getElementById('agentDashboard').style.display = 'none';
}

function showAgentDashboard(user) {
  document.getElementById('agentName').textContent = user;
  document.getElementById('agentDashboard').style.display = 'block';
  document.getElementById('dashboard').style.display = 'none';
}

async function fetchCustomerOrders() {
  const token = localStorage.getItem('token');
  try {
    const res = await fetch(API_URL + '/customer/orders', {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();
    document.getElementById('customerOrders').textContent = JSON.stringify(data, null, 2);
  } catch (error) {
    alert('Failed to fetch orders');
  }
}

async function fetchAgentAssignedOrders() {
  const token = localStorage.getItem('token');
  try {
    const res = await fetch(API_URL + '/agent/assigned-orders', {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();
    document.getElementById('agentOrders').textContent = JSON.stringify(data, null, 2);
  } catch (error) {
    alert('Failed to fetch assigned orders');
  }
}

function logout() {
  localStorage.clear();
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('agentDashboard').style.display = 'none';
  document.getElementById('message').textContent = '';
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
}
</script>

</body>
</html>
