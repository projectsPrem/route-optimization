<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delivery Logistics - Auth</title>
    <script src="https://cdn.tailwindcss.com"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body class="bg-gray-100">

<div class="flex items-center justify-center min-h-screen">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="flex">
            <button id="signin-tab" class="w-1/2 py-2 px-4 text-blue-600 border-b-2 border-blue-600 font-semibold focus:outline-none">Sign In</button>
            <button id="signup-tab" class="w-1/2 py-2 px-4 text-gray-500 hover:text-blue-600 focus:outline-none">Sign Up</button>
        </div>

        <div class="p-8 space-y-6">
            <div class="flex flex-col items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 0 1-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 2.25 12v-1.5a3.375 3.375 0 0 0 3.375-3.375H5.25l2.25-4.5h3.875a3.375 3.375 0 0 1 3.375 3.375v1.5" />
                </svg>
                <h2 id="form-title" class="mt-2 text-3xl font-bold text-center text-gray-900">Sign in to your account</h2>
            </div>

            <form id="signin-form" class="space-y-6">
                <div>
                    <label for="signin-email" class="text-sm font-medium text-gray-700">Email address</label>
                    <input
                        id="signin-email"
                        name="email"
                        type="email"
                        autocomplete="email"
                        required
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        placeholder="user@example.com"
                    />
                </div>
                <div>
                    <label for="signin-password" class="text-sm font-medium text-gray-700">Password</label>
                    <div class="relative mt-1">
                        <input
                            id="signin-password"
                            name="password"
                            type="password"
                            autocomplete="current-password"
                            required
                            class="block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            placeholder="your password"
                        />
                        <button type="button" id="toggle-signin-password-visibility" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639l4.443-7.532A1.012 1.012 0 0 1 7.41 4h9.18a1.012 1.012 0 0 1 .931.151l4.443 7.532a1.012 1.012 0 0 1 0 .639l-4.443 7.532A1.012 1.012 0 0 1 16.59 20H7.41a1.012 1.012 0 0 1-.931-.151L2.036 12.322Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                            <svg class="w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.243 4.243L6.228 6.228" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="submit" class="flex justify-center items-center w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-colors disabled:bg-gray-400">
                    Sign In
                </button>
            </form>

            <form id="signup-form" class="space-y-6 hidden">
                <div>
                   <label for="signup-name" class="text-sm font-medium text-gray-700">Full Name</label>
                   <input
                       id="signup-name"
                       name="name"
                       type="text"
                       autocomplete="name"
                       required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                       placeholder="John Doe"
                   />
               </div>
               <div>
                   <label for="signup-email" class="text-sm font-medium text-gray-700">Email address</label>
                   <input
                       id="signup-email"
                       name="email"
                       type="email"
                       autocomplete="email"
                       required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                       placeholder="user@example.com"
                   />
               </div>
               <div>
                    <label for="signup-password" class="text-sm font-medium text-gray-700">Password</label>
                    <div class="relative mt-1">
                        <input
                           id="signup-password"
                           name="password"
                           type="password"
                           autocomplete="new-password"
                           required
                           class="block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           placeholder="choose a strong password"
                        />
                        <button type="button" id="toggle-signup-password-visibility" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639l4.443-7.532A1.012 1.012 0 0 1 7.41 4h9.18a1.012 1.012 0 0 1 .931.151l4.443 7.532a1.012 1.012 0 0 1 0 .639l-4.443 7.532A1.012 1.012 0 0 1 16.59 20H7.41a1.012 1.012 0 0 1-.931-.151L2.036 12.322Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                            <svg class="w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.243 4.243L6.228 6.228" />
                            </svg>
                        </button>
                    </div>
               </div>
                <div>
                   <label for="signup-role" class="text-sm font-medium text-gray-700">I am a</label>
                   <select id="signup-role" name="role" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                       <option value="customer" selected>Customer</option>
                       <option value="agent">Agent</option>
                   </select>
               </div>
               <button type="submit" class="flex justify-center items-center w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-colors disabled:bg-gray-400">
                   Sign Up
               </button>
            </form>
        </div>
    </div>
</div>

<!-- Pop-up Modal -->
<div id="popup-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div id="modal-icon-container" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                <!-- Icon will be inserted here by JS -->
            </div>
            <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
            <div class="mt-2 px-7 py-3">
                <p id="modal-message" class="text-sm text-gray-500"></p>
            </div>

            <!-- Confirmation Section -->
            <div id="confirmation-section" class="hidden px-7 pb-3 space-y-3">
                 <input type="hidden" id="confirmation-email" />
                 <div>
                     <label for="confirmation-code" class="sr-only">Confirmation Code</label>
                     <input
                         id="confirmation-code"
                         type="text"
                         placeholder="Enter confirmation code"
                         class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                     />
                     <p id="confirmation-error" class="text-red-500 text-xs text-left mt-1 h-4"></p>
                 </div>
            </div>

            <div class="items-center px-4 py-3 space-y-2">
                 <button id="modal-confirm-btn" class="flex justify-center items-center hidden w-full px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300 disabled:bg-gray-400">
                    Confirm Account
                </button>
                <button id="modal-close-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    OK
                </button>
            </div>
        </div>
    </div>
</div>


<script>
    const API_URL = 'http://127.0.0.1:5001';

    const signinTab = document.getElementById('signin-tab');
    const signupTab = document.getElementById('signup-tab');
    const signinForm = document.getElementById('signin-form');
    const signupForm = document.getElementById('signup-form');
    const formTitle = document.getElementById('form-title');
    
    // Modal elements
    const modal = document.getElementById('popup-modal');
    const modalIconContainer = document.getElementById('modal-icon-container');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const confirmationSection = document.getElementById('confirmation-section');
    const confirmationEmailInput = document.getElementById('confirmation-email');
    const confirmationCodeInput = document.getElementById('confirmation-code');
    const confirmationError = document.getElementById('confirmation-error');

    const activeTabClasses = ['text-blue-600', 'border-b-2', 'border-blue-600', 'font-semibold'];
    const inactiveTabClasses = ['text-gray-500', 'hover:text-blue-600'];
    
    const successIcon = `<svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
    const errorIcon = `<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

    function showModal(title, message, isError = false, options = {}) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;

        modalIconContainer.innerHTML = isError ? errorIcon : successIcon;
        modalIconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${isError ? 'bg-red-100' : 'bg-green-100'}`;

        if (options.showConfirmation) {
            confirmationSection.classList.remove('hidden');
            modalConfirmBtn.classList.remove('hidden');
            confirmationEmailInput.value = options.email;
            modalCloseBtn.textContent = 'Cancel';
        } else {
            confirmationSection.classList.add('hidden');
            modalConfirmBtn.classList.add('hidden');
            modalCloseBtn.textContent = 'OK';
        }

        if (options.isRedirecting) {
            modalCloseBtn.classList.add('hidden');
        } else {
            modalCloseBtn.classList.remove('hidden');
        }

        modal.classList.remove('hidden');
    }

    function hideModal() {
        modal.classList.add('hidden');
        confirmationCodeInput.value = '';
        confirmationError.textContent = '';
    }

    function toggleTabs(isSignUp) {
        if (isSignUp) {
            formTitle.textContent = 'Create an account';
            signinForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            
            signupTab.classList.add(...activeTabClasses);
            signupTab.classList.remove(...inactiveTabClasses);
            signinTab.classList.remove(...activeTabClasses);
            signinTab.classList.add(...inactiveTabClasses);
        } else {
            formTitle.textContent = 'Sign in to your account';
            signupForm.classList.add('hidden');
            signinForm.classList.remove('hidden');
            
            signinTab.classList.add(...activeTabClasses);
            signinTab.classList.remove(...inactiveTabClasses);
            signupTab.classList.remove(...activeTabClasses);
            signupTab.classList.add(...inactiveTabClasses);
        }
    }

    async function handleConfirmSubmit() {
        const originalButtonText = modalConfirmBtn.textContent;
        modalConfirmBtn.disabled = true;
        modalConfirmBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;
        confirmationError.textContent = '';
        
        const email = confirmationEmailInput.value;
        const code = confirmationCodeInput.value;

        try {
            const response = await fetch(`${API_URL}/confirm`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, code }),
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || result.message || 'Confirmation failed');
            }
            hideModal();
            showModal('Account Confirmed!', 'Success! You can now sign in with your credentials.', false);
            toggleTabs(false);
        } catch (error) {
            confirmationError.textContent = error.message;
        } finally {
            modalConfirmBtn.disabled = false;
            modalConfirmBtn.innerHTML = originalButtonText;
        }
    }

    signinTab.addEventListener('click', () => toggleTabs(false));
    signupTab.addEventListener('click', () => toggleTabs(true));
    modalCloseBtn.addEventListener('click', hideModal);
    modalConfirmBtn.addEventListener('click', handleConfirmSubmit);
    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            hideModal();
        }
    });

    async function handleFormSubmit(form, url) {
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || result.message || 'An unknown error occurred');
            }
            
            if (url.includes('signup')) {
                showModal('Sign Up Successful', result.message, false, { showConfirmation: true, email: data.email });
                form.reset();
            } else {
                localStorage.setItem('authToken', result.AccessToken);
                let userName = 'User';
                let userRole = 'customer'; // Default role

                try {
                    const payload = JSON.parse(atob(result.IdToken.split('.')[1]));
                    userName = payload.name || 'User';
                    // Cognito stores roles in the 'cognito:groups' claim, which is an array.
                    if (payload['cognito:groups'] && payload['cognito:groups'].length > 0) {
                        userRole = payload['cognito:groups'][0].toLowerCase(); // Assume first group is role
                    }
                } catch (e) {
                    console.error('Failed to decode token or get role:', e);
                }
                
                localStorage.setItem('userName', userName);
                localStorage.setItem('userRole', userRole);

                showModal('Login Successful', 'Redirecting to your dashboard...', false, { isRedirecting: true });

                setTimeout(() => {
                    if (userRole === 'agent') {
                        window.location.href = 'agent.html';
                    } else {
                        window.location.href = 'customer.html';
                    }
                }, 1500);
            }
        } catch (error) {
            showModal('Error', error.message, true);
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
    }

    signinForm.addEventListener('submit', (e) => {
        e.preventDefault();
        handleFormSubmit(signinForm, `${API_URL}/login`);
    });

    signupForm.addEventListener('submit', (e) => {
        e.preventDefault();
        handleFormSubmit(signupForm, `${API_URL}/signup`);
    });

    function setupPasswordToggle(button, input) {
        if (!button || !input) return;
        const eyeIcon = button.children[0];
        const eyeSlashIcon = button.children[1];

        button.addEventListener('click', () => {
            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeSlashIcon.classList.remove('hidden');
            } else {
                input.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeSlashIcon.classList.add('hidden');
            }
        });
    }

    const signinPasswordInput = document.getElementById('signin-password');
    const toggleSigninPasswordBtn = document.getElementById('toggle-signin-password-visibility');
    setupPasswordToggle(toggleSigninPasswordBtn, signinPasswordInput);

    const signupPasswordInput = document.getElementById('signup-password');
    const toggleSignupPasswordBtn = document.getElementById('toggle-signup-password-visibility');
    setupPasswordToggle(toggleSignupPasswordBtn, signupPasswordInput);

    // On page load, check if user is already logged in and redirect
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('authToken');
        if (token) {
            const role = localStorage.getItem('userRole');
            if (role === 'agent') {
                window.location.href = 'agent.html';
            } else {
                window.location.href = 'customer.html';
            }
        }
    });
</script>

</body>
</html>